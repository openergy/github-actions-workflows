conda-upload:
  needs: [build, test, version]  # we want to make sure that versioning worked before uploading to conda channel
  runs-on: ubuntu-latest
  defaults:
    run:
      working-directory: ${{ github.workspace }}
  steps:
    - name: "download build"
      uses: actions/download-artifact@v2
      with:
        name: conda-build
        path: ${{ github.workspace }}/conda-build

    - name: "install and configure rclone"
      run: |
        set -e

        # https://rclone.org/install/
        wget -q https://downloads.rclone.org/rclone-current-linux-amd64.zip
        unzip rclone-current-linux-amd64.zip
        cd rclone-*-linux-amd64

        # https://askubuntu.com/questions/1357549/how-to-install-rclone-in-ubuntu-without-root

        # prepare local installation directories
        mkdir ~/.local
        mkdir ~/.local/bin
        mkdir ~/.local/share
        mkdir ~/.local/share/man
        mkdir ~/.local/share/man/man1

        # copy rclone files
        cp rclone ~/.local/bin
        chmod +x ~/.local/bin/rclone
        cp rclone.1 ~/.local/share/man/man1/

        # create conf
        cat > ~/.rclone.conf <<EOL
        [condachannel]
        type = azureblob
        account = condachannel
        key = ${{ secrets.AZURE_CONDA_CHANNEL_KEY }}

        EOL

    - name: "install miniconda with conda-build"
      uses: conda-incubator/setup-miniconda@v2
      with:
        channels: conda-forge
        conda-build-version: "*"
        auto-activate-base: true
        activate-environment: ""

    - name: "download packages, update index and upload to channel"
      run: |
        set -e
        rclone copy condachannel:static conda-build
        conda index conda-build
        rclone copy conda-build condachannel:static

name: Build Openergy python package
description: build is uploaded to conda-build artifact
inputs:
  # mandatory
  admin-github-token:
    description: Openergy admin github token
    required: true

  # optional
  conda-channel-sysadmin-url:
    description: openergy conda channel (if openergy packages are needed for build)
    required: false

  # config
  build-artifact-name:
    description: name of the artifact in which build will be stored
    required: false
    default: conda-build

outputs:
  build-version:
    description: version that is extracted from RELEASE.md
    value: ${{ steps.set-version.outputs.build-version }}
# https://github.com/marketplace/actions/setup-miniconda#use-a-default-shell
# https://github.com/marketplace/actions/setup-miniconda#important
runs:
  using: composite
  steps:
    - name: checkout repo # automatically on develop
      uses: actions/checkout@v3
      with:
        path: repo  # Relative path under $GITHUB_WORKSPACE to place the repository
        token: ${{ inputs.admin-github-token }}  # we want push to be done by Openergy Admin, for branch protection

    - name: configure git
      shell: bash -l {0}
      working-directory: ${{ github.workspace }}/repo
      run: |
        set -e
        git config --global user.name Openergy Admin
        git config --global user.email admin@openergy.fr

    - name: prepare conda cache  # https://github.com/marketplace/actions/setup-miniconda#caching
      uses: actions/cache@v2
      with:
        path: ~/conda_pkgs_dir
        key: ${{ runner.os }}-${{ hashFiles('${{ github.workspace }}/repo/requirements.txt') }}

    - name: retrieve version in RELEASE.md ('next' or version number)
      id: set-version
      shell: bash -l {0}
      working-directory: ${{ github.workspace }}/repo
      run: echo "::set-output name=build-version::$(sed -n '0,/^##/s/## //p' RELEASE.md)"

    - name: prepare version.py
      shell: bash -l {0}
      working-directory: ${{ github.workspace }}/repo
      run: printf 'version = "${{ steps.set-version.outputs.VERSION }}"\n' > ./${{ github.event.repository.name }}/version.py

    - name: add version
      shell: bash -l {0}
      working-directory: ${{ github.workspace }}/repo
      run: git add ./${{ github.event.repository.name }}/version.py

    - name: install miniconda with conda-build
      uses: conda-incubator/setup-miniconda@v2
      with:
        channels: conda-forge
        conda-build-version: "*"
        auto-activate-base: true
        activate-environment: ""

    - name: add openergy conda channel if input was provided
      shell: bash -l {0}
      working-directory: ${{ github.workspace }}
      run: |
        set -e
        [ -z ${{ inputs.conda-channel-sysadmin-url }} ] || conda config --system --add channels ${{ inputs.conda-channel-sysadmin-url }}

    - name: prepare build info
      shell: bash -l {0}
      working-directory: ${{ github.workspace }}/repo
      run: |
        set -e
        mkdir conda-build
        # download create_meta script
        # todo: change GL-refactor to master
        wget https://raw.githubusercontent.com/openergy/ogithub-actions/GL-refactor/actions/opypackage-build/create_meta.py -P ${{ github.workspace }}
        # create meta
        python ${{ github.workspace }}/create_meta.py conda-build ${{ github.event.repository.name }} false

    - name: build
      shell: bash -l {0}
      working-directory: ${{ github.workspace }}/repo/conda-build
      run: conda-build . --croot ${{ github.workspace }}/conda-build-to-upload

    - name: upload build
      uses: actions/upload-artifact@v2
      with:
        name: ${{ inputs.build-artifact-name }}
        path: ${{ github.workspace }}/conda-build-to-upload
        retention-days: 1

    - name: commit to develop
      shell: bash -l {0}
      working-directory: ${{ github.workspace }}/repo
      run: |
        set -e
        git commit -m "[CI] updated version in version.py as ${{ steps.set-version.outputs.VERSION }}" || :
        # || : => works as try/except:pass (commit may fail in certain cases if code has not changed, \
        #  but it shouldn't be a problem)
        git push origin develop
